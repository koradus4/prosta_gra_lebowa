<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Ustawienia jednostek</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <h1>Ustawienia jednostek</h1>
  <nav>
    <a href="/">Gra</a>
    <a href="/map_editor.html">Edytor mapy</a>
    <a href="/token_editor.html">Edytor żetonów</a>
    <a href="/placement_editor.html">Ustawienia jednostek</a>
  </nav>
</header>
<main>
  <div class="panel">
    <select id="type"></select>
    Właściciel: <select id="owner"><option value="0">Gracz 0</option><option value="1">Gracz 1</option></select>
    <button id="save">Zapisz</button>
    <button id="clear">Wyczyść</button>
  </div>
  <canvas id="map" width="640" height="640"></canvas>
</main>
<script>
const cell=64; let mapData, tokensDefs, placements=[];
const cvs=document.getElementById('map'); const ctx=cvs.getContext('2d');
async function api(path,opt){ const r=await fetch(path,opt); return r.json(); }
async function load(){ mapData=await api('/api/map'); tokensDefs=await api('/api/tokens'); placements=await api('/api/placements');
  for(const d of tokensDefs){ const o=document.createElement('option'); o.value=d.type; o.textContent=d.type; type.appendChild(o);} draw(); }
function draw(){ cvs.width=mapData.width*cell; cvs.height=mapData.height*cell; ctx.fillStyle='#eef'; ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.strokeStyle='#aaa'; for(let x=0;x<=mapData.width;x++){ctx.beginPath();ctx.moveTo(x*cell,0);ctx.lineTo(x*cell,cvs.height);ctx.stroke();}
  for(let y=0;y<=mapData.height;y++){ctx.beginPath();ctx.moveTo(0,y*cell);ctx.lineTo(cvs.width,y*cell);ctx.stroke();}
  for(const u of placements){ const x=u.x*cell+cell/2, y=u.y*cell+cell/2; ctx.beginPath(); ctx.fillStyle=u.owner===0?'#07f':'#f33'; ctx.arc(x,y,cell*0.35,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.fillText(u.type[0].toUpperCase(), x, y+4); } }

cvs.addEventListener('click',(e)=>{ const r=cvs.getBoundingClientRect(); const gx=Math.floor((e.clientX-r.left)/cell); const gy=Math.floor((e.clientY-r.top)/cell);
  const idx=placements.findIndex(p=>p.x===gx&&p.y===gy); if(idx>=0){ placements.splice(idx,1); } else { placements.push({ type:type.value, owner: parseInt(owner.value), x: gx, y: gy }); } draw(); });

save.onclick = async ()=>{ await api('/api/placements', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(placements) }); alert('Zapisano'); };
clear.onclick = ()=>{ placements=[]; draw(); };
load();
</script>
</body>
</html>
